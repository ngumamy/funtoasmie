FROM node:20-alpine AS builder

LABEL stage="build"

WORKDIR /app

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ Installation des dÃ©pendances
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COPY package*.json ./
RUN npm ci && npm cache clean --force

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ Build du frontend React
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ARG REACT_APP_API_URL=http://localhost:5000/api
ENV REACT_APP_API_URL=${REACT_APP_API_URL}
ENV NODE_ENV=production
ENV CI=false

COPY . .

# CrÃ©er .env.production pour le build
RUN printf "REACT_APP_API_URL=%s\n" "${REACT_APP_API_URL}" > .env.production && \
    cat .env.production

# Build
RUN npm run build

# âš ï¸ VÃ©rifier que le build a rÃ©ussi
RUN if [ ! -d "/app/build" ]; then \
      echo "âŒ ERREUR: RÃ©pertoire /app/build non trouvÃ© aprÃ¨s le build!"; \
      ls -la /app/; \
      exit 1; \
    fi && \
    echo "âœ… Build rÃ©ussi: /app/build existe" && \
    ls -la /app/build | head -20

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŸ¢ Stage production: Nginx avec frontend compilÃ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FROM nginx:1.27-alpine AS production

LABEL version="1.0.0"
LABEL description="Frontend FUNTOA SMIE"
LABEL maintainer="ilo-CS"

# âš ï¸ Supprimer la config default de nginx
RUN rm -f /etc/nginx/conf.d/default.conf

# Copier la config nginx personnalisÃ©e
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

# Copier les fichiers du frontend compilÃ©
COPY --from=builder /app/build /usr/share/nginx/html

# âš ï¸ VÃ©rifier que les fichiers sont prÃ©sents
RUN if [ ! -f "/usr/share/nginx/html/index.html" ]; then \
      echo "âŒ ERREUR: /usr/share/nginx/html/index.html non trouvÃ©!"; \
      ls -la /usr/share/nginx/html/ || echo "RÃ©pertoire vide!"; \
      exit 1; \
    fi && \
    echo "âœ… Frontend files copiÃ© correctement" && \
    ls -la /usr/share/nginx/html/

# Note: Ne pas valider nginx -t ici car "backend:5000" n'existe pas au build time
# La validation se fera au runtime quand les DNS seront rÃ©solus

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

