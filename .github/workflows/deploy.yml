name: Build and Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: funtoa-backend
  FRONTEND_IMAGE: funtoa-frontend
  REPOSITORY_OWNER: ${{ github.repository_owner }}

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Dockerfiles exist
        run: |
          if [ ! -f "./backend/Dockerfile" ]; then
            echo "‚ùå Backend Dockerfile not found!"
            exit 1
          fi
          if [ ! -f "./frontend/Dockerfile" ]; then
            echo "‚ùå Frontend Dockerfile not found!"
            exit 1
          fi
          echo "‚úÖ All Dockerfiles found"

      - name: Validate docker-compose files
        run: |
          if [ ! -f "./docker-compose.prod.yml" ]; then
            echo "‚ö†Ô∏è docker-compose.prod.yml not found, but will use docker-compose.yml if available"
          else
            echo "‚úÖ docker-compose.prod.yml found"
          fi

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Run linter (ESLint)
        run: |
          cd backend
          npm install --save-dev eslint eslint-config-airbnb-base eslint-plugin-import
          npx eslint . --max-warnings=0 || true
        continue-on-error: true

      - name: Run backend tests
        run: |
          cd backend
          npm test -- --coverage --testPathPattern="__tests__"

      - name: Upload backend coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run linter (ESLint)
        run: |
          cd frontend
          npx eslint src --max-warnings=0 || true
        continue-on-error: true

      - name: Run frontend tests
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false

      - name: Upload frontend coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  build-and-push:
    name: Build and Push Docker Images
    needs: [validate, test-backend, test-frontend]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set repository owner (lowercase)
        id: repo-owner
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "‚úÖ Repository owner: ${{ github.repository_owner }} -> $REPO_OWNER_LOWER"

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.repo-owner.outputs.owner }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.repo-owner.outputs.owner }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL || 'http://37.59.118.164:5000/api' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy:
    name: Deploy to VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate VPS and registry secrets
        run: |
          if [ -z "${{ secrets.IP_SRV }}" ]; then
            echo "‚ùå Secret IP_SRV is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.USR_SRV }}" ]; then
            echo "‚ùå Secret USR_SRV is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PK }}" ]; then
            echo "‚ùå Secret SSH_PK is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.PORT_SRV }}" ]; then
            echo "‚ùå Secret PORT_SRV is not set!"
            exit 1
          fi
          # GHCR_TOKEN should be set as a PAT with read:packages for the server to pull private images
          if [ -z "${{ secrets.GHCR_TOKEN }}" ]; then
            echo "‚ùå Secret GHCR_TOKEN is not set! Please provide a PAT with read:packages (GHCR_TOKEN)."
            exit 1
          fi
          echo "‚úÖ All required secrets are set"
          echo "‚úÖ SSH Port configured: ${{ secrets.PORT_SRV }}"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 15
        with:
          host: ${{ secrets.IP_SRV }}
          username: ${{ secrets.USR_SRV }}
          key: ${{ secrets.SSH_PK }}
          port: ${{ secrets.PORT_SRV }}
          script: |
            set -e
            
            echo "üöÄ D√©marrage du d√©ploiement..."
            
            # V√©rifier que Docker est install√©
            if ! command -v docker &> /dev/null; then
              echo "‚ùå Docker n'est pas install√© sur le serveur!"
              exit 1
            fi
            
            # V√©rifier que Docker Compose est install√©
            if ! command -v docker compose &> /dev/null && ! command -v docker-compose &> /dev/null; then
              echo "‚ùå Docker Compose n'est pas install√© sur le serveur!"
              exit 1
            fi
            
            # D√©finir la commande docker compose
            if command -v docker compose &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            else
              DOCKER_COMPOSE="docker-compose"
            fi
            
            # Naviguer vers le r√©pertoire du projet
            DEPLOY_DIR="/opt/funtoa"
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "‚ùå R√©pertoire $DEPLOY_DIR introuvable!"
              echo "üìù Cr√©ation du r√©pertoire..."
              sudo mkdir -p $DEPLOY_DIR || { echo "‚ùå Impossible de cr√©er le r√©pertoire!"; exit 1; }
              # Changer la propri√©t√© sur l'utilisateur de d√©ploiement (USR_SRV)
              sudo chown ${{ secrets.USR_SRV }}:${{ secrets.USR_SRV }} $DEPLOY_DIR || true
            fi
            
            cd $DEPLOY_DIR || { echo "‚ùå Impossible d'acc√©der au r√©pertoire $DEPLOY_DIR!"; exit 1; }
            
            # Initialiser Git si le r√©pertoire n'est pas un d√©p√¥t Git
            if [ ! -d ".git" ]; then
              echo "üìù Initialisation du d√©p√¥t Git..."
              git init || { echo "‚ùå √âchec de l'initialisation Git!"; exit 1; }
              git remote add origin https://github.com/${{ github.repository }}.git || git remote set-url origin https://github.com/${{ github.repository }}.git
            fi
            
            # R√©cup√©rer les derni√®res modifications
            echo "üì• R√©cup√©ration des derni√®res modifications..."
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")
            git fetch origin main || git fetch origin master || true
            git checkout main 2>/dev/null || git checkout master 2>/dev/null || git checkout -b main
            git pull origin main 2>/dev/null || git pull origin master 2>/dev/null || echo "‚ö†Ô∏è Aucune mise √† jour disponible"
            
            # Se connecter au registre GitHub Container Registry
            echo "üîê Authentification au registre Docker..."
            GHCR_TOKEN="${{ secrets.GHCR_TOKEN }}"
            if [ -z "$GHCR_TOKEN" ]; then
              echo "‚ùå GHCR_TOKEN is empty on runner; aborting"
              exit 1
            fi
            echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || { 
              echo "‚ùå √âchec de la connexion au registre!"
              exit 1
            }
            
            # Utiliser docker-compose.prod.yml pour la production
            COMPOSE_FILE="docker-compose.prod.yml"
            if [ ! -f "$COMPOSE_FILE" ]; then
              echo "‚ö†Ô∏è Fichier $COMPOSE_FILE introuvable, utilisation de docker-compose.yml"
              COMPOSE_FILE="docker-compose.yml"
              if [ ! -f "$COMPOSE_FILE" ]; then
                echo "‚ùå Aucun fichier docker-compose trouv√©!"
                exit 1
              fi
            fi
            
            # V√©rifier que le fichier .env existe
            if [ ! -f ".env" ]; then
              echo "‚ö†Ô∏è Fichier .env non trouv√©!"
              echo "üìù Veuillez cr√©er un fichier .env avant de d√©ployer"
              if [ -f ".env.example" ]; then
                echo "üí° Un fichier .env.example est disponible, vous pouvez le copier et le modifier"
              fi
            fi
            
            # D√©finir les noms d'images pour la production (en minuscules)
            REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            export BACKEND_IMAGE="${{ env.REGISTRY }}/$REPO_OWNER_LOWER/${{ env.BACKEND_IMAGE }}:latest"
            export FRONTEND_IMAGE="${{ env.REGISTRY }}/$REPO_OWNER_LOWER/${{ env.FRONTEND_IMAGE }}:latest"
            
            echo "üì¶ Backend image: $BACKEND_IMAGE"
            echo "üì¶ Frontend image: $FRONTEND_IMAGE"
            
            # Arr√™ter les conteneurs existants (sans supprimer les volumes)
            echo "üõë Arr√™t des conteneurs existants..."
            $DOCKER_COMPOSE -f $COMPOSE_FILE down --remove-orphans || true
            
            # T√©l√©charger les nouvelles images
            echo "üì• T√©l√©chargement des nouvelles images..."
            $DOCKER_COMPOSE -f $COMPOSE_FILE pull || { 
              echo "‚ùå √âchec du t√©l√©chargement des images!"
              echo "üí° V√©rifiez que les images ont √©t√© correctement pouss√©es vers le registre"
              exit 1
            }
            
            # D√©marrer les conteneurs
            echo "üöÄ D√©marrage des conteneurs..."
            $DOCKER_COMPOSE -f $COMPOSE_FILE up -d --remove-orphans || { 
              echo "‚ùå √âchec du d√©marrage des conteneurs!"
              echo "üìã Affichage des logs d'erreur..."
              $DOCKER_COMPOSE -f $COMPOSE_FILE logs --tail=50
              exit 1
            }
            
            # Attendre que les services soient pr√™ts
            echo "‚è≥ Attente du d√©marrage des services..."
            sleep 10
            
            # V√©rifier l'√©tat des conteneurs
            echo "üìä √âtat des conteneurs:"
            $DOCKER_COMPOSE -f $COMPOSE_FILE ps
            
            # V√©rifier que tous les services r√©pondent (smoke test) si SMOKE_URL est fourni
            if [ -n "${{ secrets.SMOKE_URL }}" ]; then
              echo "üîé Smoke test: ${{ secrets.SMOKE_URL }}"
              RETRIES=10
              SLEEP=3
              OK=0
              for i in $(seq 1 $RETRIES); do
                if curl -fsS "${{ secrets.SMOKE_URL }}" >/dev/null 2>&1; then
                  OK=1
                  break
                fi
                echo "Attente du service... ($i/$RETRIES)"
                sleep $SLEEP
              done
              if [ "$OK" -ne 1 ]; then
                echo "‚ùå Smoke test failed for ${{ secrets.SMOKE_URL }}"
                $DOCKER_COMPOSE -f $COMPOSE_FILE ps
                $DOCKER_COMPOSE -f $COMPOSE_FILE logs --tail=50
                exit 1
              fi
              echo "‚úÖ Smoke test passed"
            else
              # Fallback: v√©rifier l'√©tat via docker compose ps (recherche simple d'Exit)
              EXITED_COUNT=$($DOCKER_COMPOSE -f $COMPOSE_FILE ps --filter "status=exited" --format "{{.Name}}" | wc -l || echo 0)
              if [ "$EXITED_COUNT" -gt "0" ]; then
                echo "‚ùå Certains conteneurs sont dans l'√©tat exited"
                $DOCKER_COMPOSE -f $COMPOSE_FILE ps
                $DOCKER_COMPOSE -f $COMPOSE_FILE logs --tail=50
                exit 1
              fi
            fi
            
            # Afficher les logs r√©cents pour v√©rification
            echo "üìã Logs r√©cents:"
            $DOCKER_COMPOSE -f $COMPOSE_FILE logs --tail=30
            
            # Nettoyer les images non utilis√©es (en arri√®re-plan pour ne pas bloquer)
            echo "üßπ Nettoyage des images non utilis√©es..."
            docker image prune -af --filter "until=24h" || true
            
            echo ""
            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
            echo "üìä R√©sum√©:"
            $DOCKER_COMPOSE -f $COMPOSE_FILE ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
